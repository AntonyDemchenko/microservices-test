# üß© Microservices Test Project

–¶–µ–π –ø—Ä–æ—î–∫—Ç –¥–µ–º–æ–Ω—Å—Ç—Ä—É—î –ø—Ä–∏–∫–ª–∞–¥ –ø—Ä–æ—Å—Ç–æ—ó –º—ñ–∫—Ä–æ—Å–µ—Ä–≤—ñ—Å–Ω–æ—ó –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∏ –Ω–∞ –æ—Å–Ω–æ–≤—ñ **NestJS**, **PostgreSQL**, **Prometheus** —ñ **LocalStack (AWS SQS)**.

---

## üöÄ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ—î–∫—Ç—É

```
microservices-test/
‚îú‚îÄ‚îÄ docker-compose.yml          # –û—Å–Ω–æ–≤–Ω–∞ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è –¥–ª—è –≤—Å—ñ—Ö —Å–µ—Ä–≤—ñ—Å—ñ–≤
‚îú‚îÄ‚îÄ init-localstack.sh          # –°–∫—Ä–∏–ø—Ç —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó LocalStack (—Å—Ç–≤–æ—Ä—é—î SQS —á–µ—Ä–≥—É)
‚îú‚îÄ‚îÄ prometheus.yml              # –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è Prometheus
‚îÇ
‚îú‚îÄ‚îÄ products-service/           # –°–µ—Ä–≤—ñ—Å —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –ø—Ä–æ–¥—É–∫—Ç–∞–º–∏
‚îÇ   ‚îú‚îÄ‚îÄ .env                    # –õ–æ–∫–∞–ª—å–Ω—ñ –∑–º—ñ–Ω–Ω—ñ –¥–ª—è npm start
‚îÇ   ‚îú‚îÄ‚îÄ .env.prod               # –ó–º—ñ–Ω–Ω—ñ –¥–ª—è Docker
‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile
‚îÇ   ‚îú‚îÄ‚îÄ node-pg-migrate.config.js
‚îÇ   ‚îú‚îÄ‚îÄ migrations/             # –§–∞–π–ª–∏ –º—ñ–≥—Ä–∞—Ü—ñ–π
‚îÇ   ‚îî‚îÄ‚îÄ src/
‚îÇ
‚îî‚îÄ‚îÄ notifications-service/      # –°–µ—Ä–≤—ñ—Å –¥–ª—è –æ–±—Ä–æ–±–∫–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –∑ SQS
    ‚îú‚îÄ‚îÄ .env
    ‚îú‚îÄ‚îÄ .env.prod
    ‚îú‚îÄ‚îÄ Dockerfile
    ‚îî‚îÄ‚îÄ src/
```

---

## ‚öôÔ∏è –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω—ñ —Ç–µ—Ö–Ω–æ–ª–æ–≥—ñ—ó

- **NestJS** ‚Äì –±–µ–∫–µ–Ω–¥-—Ñ—Ä–µ–π–º–≤–æ—Ä–∫ –¥–ª—è —Å–µ—Ä–≤—ñ—Å—ñ–≤
- **PostgreSQL** ‚Äì –±–∞–∑–∞ –¥–∞–Ω–∏—Ö
- **LocalStack** ‚Äì –ª–æ–∫–∞–ª—å–Ω–∞ –µ–º—É–ª—è—Ü—ñ—è AWS SQS
- **Prometheus** ‚Äì –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ —ñ –º–µ—Ç—Ä–∏–∫–∏
- **Docker Compose** ‚Äì –∑–∞–ø—É—Å–∫ —É—Å—ñ—Ö —Å–µ—Ä–≤—ñ—Å—ñ–≤ —É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞—Ö

---

## üß∞ –°–µ—Ä–≤—ñ—Å–∏

| –°–µ—Ä–≤—ñ—Å                     | –û–ø–∏—Å                                     | –ü–æ—Ä—Ç   |
| -------------------------- | ---------------------------------------- | ------ |
| üü¢ `products-service`      | –ö–µ—Ä—É—î –ø—Ä–æ–¥—É–∫—Ç–∞–º–∏, –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î –ø–æ–¥—ñ—ó —É SQS | `3000` |
| üîî `notifications-service` | –û—Ç—Ä–∏–º—É—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ SQS               | `3001` |
| üóÑÔ∏è `PostgreSQL`            | –û—Å–Ω–æ–≤–Ω–∞ –±–∞–∑–∞ –¥–∞–Ω–∏—Ö                       | `5432` |
| üì¶ `LocalStack`            | –ï–º—É–ª—è—Ü—ñ—è AWS SQS                         | `4566` |
| üìà `Prometheus`            | –ó–±—ñ—Ä —ñ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –º–µ—Ç—Ä–∏–∫               | `9090` |

---

## üßæ –ü–æ–ø–µ—Ä–µ–¥–Ω—ñ –≤–∏–º–æ–≥–∏

–ü–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º –ø–µ—Ä–µ–∫–æ–Ω–∞–π—Å—è, —â–æ –≤ —Ç–µ–±–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ñ:

- **Docker** ‚â• 24
- **Docker Compose** ‚â• 2
- **Node.js** ‚â• 18 (–¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ—ó —Ä–æ–∑—Ä–æ–±–∫–∏)

---

## üöÄ –ó–∞–ø—É—Å–∫ –ø—Ä–æ—î–∫—Ç—É

### üîπ 1. –°—Ç–≤–æ—Ä–µ–Ω–Ω—è SQS —á–µ—Ä–≥–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ

–°–∫—Ä–∏–ø—Ç `init-localstack.sh` —Å—Ç–≤–æ—Ä—é—î —Ç–µ—Å—Ç–æ–≤—É —á–µ—Ä–≥—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—Ä–∏ –∑–∞–ø—É—Å–∫—É LocalStack.

### üîπ 2. –ó–∞–ø—É—Å–∫ —É—Å—ñ—Ö —Å–µ—Ä–≤—ñ—Å—ñ–≤

```bash
docker-compose up --build
```

–ü—ñ—Å–ª—è —Ü—å–æ–≥–æ –±—É–¥—É—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ñ —Å–µ—Ä–≤—ñ—Å–∏:

| –°–µ—Ä–≤—ñ—Å               | URL                   |
| -------------------- | --------------------- |
| Products API         | http://localhost:3000 |
| Notifications API    | http://localhost:3001 |
| Prometheus Dashboard | http://localhost:9090 |
| PostgreSQL           | localhost:5432        |
| LocalStack Dashboard | http://localhost:4566 |

---

## üß™ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ä–æ–±–æ—Ç–∏

### üî∏ –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —á–µ—Ä–≥—É SQS

```bash
docker exec -it localstack awslocal sqs list-queues
```

### üî∏ –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –º–µ—Ç—Ä–∏–∫–∏ `products-service`

http://localhost:3000/metrics

### üî∏ –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ Prometheus Targets

http://localhost:9090/targets  
‚Üí `products-service:3000` –º–∞—î —Å—Ç–∞—Ç—É—Å **UP**

---

## üóÉÔ∏è –ú—ñ–≥—Ä–∞—Ü—ñ—ó –±–∞–∑–∏ –¥–∞–Ω–∏—Ö

–£ `products-service` –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è **[node-pg-migrate](https://github.com/salsita/node-pg-migrate)** –¥–ª—è —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –º—ñ–≥—Ä–∞—Ü—ñ—è–º–∏ PostgreSQL.

### üîπ –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è

–§–∞–π–ª: `products-service/node-pg-migrate.config.js`

```js
module.exports = {
  migrationFolder: "./migrations",
  direction: "up",
  databaseUrl: process.env.DATABASE_URL,
  migrationsTable: "pgmigrations",
  dir: "migrations",
};
```

–ú—ñ–≥—Ä–∞—Ü—ñ—ó –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è —É –ø–∞–ø—Ü—ñ:

```
products-service/migrations/
```

### üîπ –ü—Ä–∏–∫–ª–∞–¥ –º—ñ–≥—Ä–∞—Ü—ñ—ó

–§–∞–π–ª: `1762606774674_create-products-table.js`

```js
exports.up = (pgm) => {
  pgm.createTable("products", {
    id: "id",
    name: { type: "text", notNull: true },
    price: { type: "numeric(10,2)", notNull: true },
    created_at: { type: "timestamp", default: pgm.func("now()") },
  });
};

exports.down = (pgm) => {
  pgm.dropTable("products");
};
```

### üîπ –Ø–∫ –∑–∞–ø—É—Å–∫–∞—Ç–∏ –º—ñ–≥—Ä–∞—Ü—ñ—ó

#### üì¶ 1. –õ–æ–∫–∞–ª—å–Ω–æ (—á–µ—Ä–µ–∑ npm)

```bash
cd products-service
npm run migrate:up
```

#### üê≥ 2. –£—Å–µ—Ä–µ–¥–∏–Ω—ñ Docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞

```bash
docker exec -it products-service npm run migrate:up
```

> –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –∑–º—ñ–Ω–Ω–∞ `DATABASE_URL`  
> —ñ–∑ `.env` –∞–±–æ `.env.prod` ‚Äî –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ –¥–æ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞.

#### üîπ –û–Ω–æ–≤–ª–µ–Ω–Ω—è / –≤—ñ–¥–∫–∞—Ç

```bash
npm run migrate:down     # –≤—ñ–¥–∫–∞—Ç –æ—Å—Ç–∞–Ω–Ω—å–æ—ó –º—ñ–≥—Ä–∞—Ü—ñ—ó
npm run migrate:create   # —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–æ–≤–æ—ó –º—ñ–≥—Ä–∞—Ü—ñ—ó
```

### üß© –ü–æ—Ä–∞–¥–∞

- –ö–æ–∂–Ω–∞ –Ω–æ–≤–∞ —Ç–∞–±–ª–∏—Ü—è —á–∏ –∑–º—ñ–Ω–∞ –≤ —Å—Ö–µ–º—ñ –ë–î –º–∞—î –±—É—Ç–∏ –¥–æ–¥–∞–Ω–∞ —á–µ—Ä–µ–∑ –Ω–æ–≤—É –º—ñ–≥—Ä–∞—Ü—ñ—é.
- –ú—ñ–≥—Ä–∞—Ü—ñ—ó –¥–æ–∑–≤–æ–ª—è—é—Ç—å –æ–Ω–æ–≤–ª—é–≤–∞—Ç–∏ –±–∞–∑—É **–±–µ–∑ –≤—Ç—Ä–∞—Ç–∏ –¥–∞–Ω–∏—Ö** –ø—Ä–∏ –¥–µ–ø–ª–æ—ó.
- –¢–∞–±–ª–∏—Ü—è `pgmigrations` –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–±–µ—Ä—ñ–≥–∞—î —ñ—Å—Ç–æ—Ä—ñ—é –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–∏—Ö –º—ñ–≥—Ä–∞—Ü—ñ–π.

---

## üß™ E2E-—Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è

E2E-—Ç–µ—Å—Ç–∏ –ø–µ—Ä–µ–≤—ñ—Ä—è—é—Ç—å –ø–æ–≤–Ω—É —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—é –º—ñ–∂ `products-service`, –±–∞–∑–æ—é –¥–∞–Ω–∏—Ö —ñ SQS —É LocalStack.

---

### üîπ 1. –ü–µ—Ä–µ–¥—É–º–æ–≤–∏

–ü–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º —Ç–µ—Å—Ç—ñ–≤ –ø–æ—Ç—Ä—ñ–±–Ω–æ:

- –∑–∞–ø—É—Å—Ç–∏—Ç–∏ **PostgreSQL** —ñ **LocalStack** —á–µ—Ä–µ–∑ Docker Compose;
- –ø–µ—Ä–µ–∫–æ–Ω–∞—Ç–∏—Å—è, —â–æ LocalStack –¥–æ—Å—Ç—É–ø–Ω–∏–π –∑–∞ `http://localhost:4566`;
- —Å—Ç–≤–æ—Ä–∏—Ç–∏ SQS-—á–µ—Ä–≥—É (—Ü–µ —Ä–æ–±–∏—Ç—å `init-localstack.sh`).

---

### üîπ 2. –õ–æ–∫–∞–ª—å–Ω—ñ –∑–º—ñ–Ω–Ω—ñ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞

–î–ª—è —Ç–µ—Å—Ç—ñ–≤ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è `products-service/.env`, —É —è–∫–æ–º—É –∑–∞–¥–∞–Ω—ñ –ª–æ–∫–∞–ª—å–Ω—ñ —Ö–æ—Å—Ç–∏:

```env
# PostgreSQL
DATABASE_URL=postgres://postgres:root@localhost:5432/legaltech_test

# AWS / LocalStack
AWS_REGION=us-east-1
AWS_ACCESS_KEY_ID=test
AWS_SECRET_ACCESS_KEY=test
AWS_SQS_ENDPOINT=http://localhost:4566
AWS_SQS_QUEUE_URL=http://localhost:4566/000000000000/test-queue

# App
PORT=3000
```

---

### üîπ 3. –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç—ñ–≤

```bash
cd products-service
npm run test:e2e
```

> –¢–µ—Å—Ç –ø—ñ–¥–Ω—ñ–º–∞—î NestJS-–¥–æ–¥–∞—Ç–æ–∫ —É –ø—Ä–æ—Ü–µ—Å—ñ —Ç–µ—Å—Ç—É, —Å—Ç–≤–æ—Ä—é—î —Ç–∏–º—á–∞—Å–æ–≤—É SQS-—á–µ—Ä–≥—É,
> –Ω–∞–¥—Å–∏–ª–∞—î –∑–∞–ø–∏—Ç `POST /products`, –æ—Ç—Ä–∏–º—É—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ —á–µ—Ä–≥–∏ —Ç–∞ –ø–µ—Ä–µ–≤—ñ—Ä—è—î –π–æ–≥–æ –≤–º—ñ—Å—Ç.

---

### üîπ 4. –û—á—ñ–∫—É–≤–∞–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

```
PASS  test/app.e2e-spec.ts
  Integration (in-process): ProductsService ‚Üí SQS
    ‚úì —Å—Ç–≤–æ—Ä—é—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ –Ω–∞—à—ñ–π —Ç–µ—Å—Ç–æ–≤—ñ–π —á–µ—Ä–∑—ñ (400 ms)
```

> –Ø–∫—â–æ Jest –ø–æ–∫–∞–∑—É—î  
> `Jest did not exit one second after the test run has completed` ‚Äî  
> —Ü–µ –æ–∑–Ω–∞—á–∞—î, —â–æ –ª–∏—à–∏–ª–∏—Å—å –≤—ñ–¥–∫—Ä–∏—Ç—ñ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ñ –ø—Ä–æ—Ü–µ—Å–∏. –¶–µ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ.

---

### üîπ 5. –¢–∏–ø–æ–≤—ñ –ø–æ–º–∏–ª–∫–∏

| –ü–æ–º–∏–ª–∫–∞                                      | –ü—Ä–∏—á–∏–Ω–∞                       | –†—ñ—à–µ–Ω–Ω—è                                                    |
| -------------------------------------------- | ----------------------------- | ---------------------------------------------------------- |
| `ECONNREFUSED localhost:4566`                | LocalStack –Ω–µ –∑–∞–ø—É—â–µ–Ω–∏–π       | –ó–∞–ø—É—Å—Ç–∏ `docker compose up localstack`                     |
| `QueueDoesNotExist`                          | –ß–µ—Ä–≥–∞ –Ω–µ —Å—Ç–≤–æ—Ä–µ–Ω–∞             | –ü–µ—Ä–µ–≤—ñ—Ä `init-localstack.sh` –∞–±–æ —Å—Ç–≤–æ—Ä–∏ –≤—Ä—É—á–Ω—É             |
| `expect(received).toBeGreaterThan(expected)` | –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –Ω–µ –¥—ñ–π—à–ª–æ –¥–æ SQS | –ó–±—ñ–ª—å—à–∏ `WaitTimeSeconds` —É —Ç–µ—Å—Ç—ñ –∞–±–æ –ø–µ—Ä–µ–≤—ñ—Ä `SqsService` |

---

### üîπ 6. –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—è —Ä–æ–±–æ—Ç–∏ –ø—ñ—Å–ª—è —Ç–µ—Å—Ç—ñ–≤

```bash
docker-compose down
```

–î–ª—è –ø–æ–≤–Ω–æ–≥–æ –æ—á–∏—â–µ–Ω–Ω—è volume (PostgreSQL, LocalStack):

```bash
docker-compose down -v
```

---

## üìä –ü—Ä–∏–∫–ª–∞–¥ –º–µ—Ç—Ä–∏–∫

```text
# HELP products_created_total Created products
# TYPE products_created_total counter
products_created_total 3

# HELP products_deleted_total Deleted products
# TYPE products_deleted_total counter
products_deleted_total 0
```

---

## üí° –ü—Ä–∏–º—ñ—Ç–∫–∏

- `.env` ‚Äî –¥–ª—è **–ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫—É** —á–µ—Ä–µ–∑ `npm start`
- `.env.prod` ‚Äî –¥–ª—è **Docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ñ–≤**
- Prometheus –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ–ø–∏—Ç—É—î `/metrics`-–µ–Ω–¥–ø–æ—ñ–Ω—Ç–∏ —Å–µ—Ä–≤—ñ—Å—ñ–≤
- LocalStack —Å—Ç–≤–æ—Ä—é—î SQS-—á–µ—Ä–≥—É `test-queue` –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ

---

## üë®‚Äçüíª –ê–≤—Ç–æ—Ä

**Anton Demchenko**  
Fullstack Developer (NestJS / React / Node.js)
